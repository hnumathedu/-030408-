<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>030408í˜¸ ì‹¤ìŠµì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <style>
        /* ğŸ“± iOS ê°ì„± ê³µí†µ ë ˆì´ì•„ì›ƒ */
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Pretendard", sans-serif; padding: 20px; background-color: #f2f2f7; margin: 0; color: #1c1c1e; }
        .title-container { text-align: center; padding: 40px 0; }
        h1 { display: inline-block; color: #000; font-weight: 700; letter-spacing: -0.5px; cursor: default; user-select: none; margin: 0; font-size: 1.8em; }
        
        .main-container { display: flex; gap: 25px; max-width: 1300px; margin: 0 auto; flex-wrap: wrap; }
        .form-section, .calendar-section { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: none; }
        .form-section { flex: 1; min-width: 320px; padding: 30px; height: fit-content; }
        .calendar-section { flex: 2.5; min-width: 600px; padding: 20px; }
        
        h3 { margin-top: 0; color: #007aff; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.85em; color: #8e8e93; }
        input, select { width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 15px; background: #fdfdfd; outline: none; transition: border 0.2s; -webkit-appearance: none; }
        input:focus, select:focus { border-color: #007aff; }

        .time-select-container { display: flex; align-items: center; gap: 5px; }
        .time-select-container span { font-size: 0.8em; color: #1c1c1e; }
        
        #submitBtn { width: 100%; padding: 15px; background: #007aff; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; transition: opacity 0.2s; }
        #submitBtn:active { opacity: 0.7; }
        #submitBtn:disabled { background: #aeaeb2; cursor: not-allowed; }

        /* ğŸ—“ï¸ iOS ìŠ¤íƒ€ì¼ FullCalendar ì»¤ìŠ¤í…€ */
        .fc { border: none !important; }
        .fc-toolbar-title { font-size: 1.1em !important; font-weight: 700 !important; color: #1c1c1e; }
        .fc .fc-button-primary { background-color: #e9e9eb !important; border: none !important; color: #007aff !important; font-weight: 600 !important; border-radius: 8px !important; padding: 6px 12px; }
        .fc .fc-button-active { background-color: #007aff !important; color: white !important; }
        .fc-col-header-cell-cushion { color: #8e8e93 !important; font-size: 0.8em; font-weight: 600; text-decoration: none !important; }
        .fc-daygrid-day-number { padding: 10px 12px !important; font-weight: 500 !important; color: #1c1c1e !important; text-decoration: none !important; font-size: 0.9em; display: inline-block !important; width: fit-content; }
        
        .fc-day-sun .fc-col-header-cell-cushion, .fc-day-sun .fc-daygrid-day-number { color: #ff3b30 !important; }
        .fc-day-sat .fc-col-header-cell-cushion, .fc-day-sat .fc-daygrid-day-number { color: #007aff !important; }
        
        .fc-day-today { background-color: transparent !important; }
        .fc-day-today .fc-daygrid-day-number { color: white !important; background-color: #ff3b30 !important; border-radius: 50% !important; min-width: 32px; height: 32px; display: flex !important; align-items: center; justify-content: center; margin: 4px 0 0 4px !important; padding: 0 !important; }
        
        .fc-event { background: #f0f7ff !important; border: none !important; border-left: 3px solid #007aff !important; border-radius: 4px !important; margin: 2px 4px !important; }
        .event-item-custom { padding: 3px 6px; color: #007aff; display: flex; align-items: center; gap: 5px; overflow: hidden; white-space: nowrap; }
        .event-time-tag { font-weight: 700; font-size: 10px; flex-shrink: 0; }
        .event-title-tag { font-weight: 500; font-size: 11px; text-overflow: ellipsis; overflow: hidden; }

        /* ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-section { max-width: 1300px; margin: 40px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* ğŸ”„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .refresh-btn { 
            display: flex; align-items: center; gap: 6px; background: #f2f2f7; border: none; padding: 8px 14px; 
            border-radius: 10px; color: #007aff; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; 
        }
        .refresh-btn:hover { background: #e5e5ea; }
        .refresh-btn:active { transform: scale(0.95); }
        .refresh-btn svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .refresh-btn.loading svg { transform: rotate(360deg); }

        table { width: 100%; border-collapse: collapse; }
        th { color: #8e8e93; font-weight: 500; font-size: 0.85em; padding: 15px; border-bottom: 1px solid #f2f2f7; }
        td { text-align: center; padding: 15px; border-bottom: 1px solid #f2f2f7; font-size: 14px; }
        
        .cancel-btn { background: #f2f2f7; color: #ff3b30; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background 0.2s; }
        .cancel-btn:hover { background: #ffebeb; }
        
        .admin-id { font-weight: 600; color: #007aff; }

        /* ğŸ’¡ ìƒíƒœë³„ í–‰ ìŠ¤íƒ€ì¼ */
       .row-past { background-color: #fafafa; color: #aeaeb2; } /* ì§€ë‚œ ì˜ˆì•½: ë°°ê²½ íšŒìƒ‰, ê¸€ì íë¦¬ê²Œ */
       .row-past .cancel-btn { display: none; } /* ì§€ë‚œ ì˜ˆì•½ì€ ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¹€ */

       /* ğŸ·ï¸ ìƒíƒœ íƒœê·¸ ë””ìì¸ */
       .status-tag { 
           padding: 4px 10px; 
           border-radius: 6px; 
           font-size: 11px; 
           font-weight: 700; 
       }

       /* ìƒíƒœë³„ ìƒ‰ìƒ ìƒì„¸ ì •ì˜ */
       .tag-now { background: #e1f7e7; color: #34c759; }      /* ì§„í–‰ ì¤‘ (ì´ˆë¡) */
       .tag-upcoming { background: #e1f0ff; color: #007aff; } /* ì˜ˆì • (íŒŒë‘) */
       .tag-past { background: #efeff4; color: #8e8e93; }     /* ì¢…ë£Œ (íšŒìƒ‰) */

       /* ì§€ë‚œ ì˜ˆì•½ í–‰ ìŠ¤íƒ€ì¼ */
       .row-past { background-color: #f9f9fb; color: #aeaeb2; }
       .row-past .cancel-btn { display: none !important; }

       /* ì§„í–‰ ì¤‘ì¸ ì˜ˆì•½ë„ ì·¨ì†Œë¥¼ ë§‰ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš” */
       .tag-now + .cancel-btn { display: none; }

      /* ğŸ” ê´€ë¦¬ì ëª¨ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .admin-badge {
            display: none;
            background: #5856d6;
            color: white;
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 20px;
            margin-left: 10px;
            vertical-align: middle;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(88, 86, 214, 0.3);
        }

        /* ê´€ë¦¬ì í•´ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .admin-exit-btn {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            background: #f2f2f7;
            color: #5856d6;
            border: 1px solid #5856d6;
            padding: 4px 10px;
            border-radius: 15px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            vertical-align: middle;
            transition: all 0.2s;
        }

        .admin-exit-btn:hover {
            background: #5856d6;
            color: white;
        }

        /* ê´€ë¦¬ì ëª¨ë“œ í™œì„± ì‹œ í…Œë‘ë¦¬ */
        body.admin-active {
            border: 5px solid #5856d6;
            min-height: 100vh;
        }

        .admin-only-controls {
            display: none;
            margin-top: 10px;
        }

        /* ğŸ“± ëª¨ë°”ì¼ ìµœì í™” ì½”ë“œ */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .title-container { padding: 20px 0; }
            h1 { font-size: 1.2em; line-height: 1.4; padding: 0 10px; width: 100%; word-break: keep-all; }

            .main-container { gap: 15px; }
            .form-section, .calendar-section { 
                flex: none; 
                width: 100%; 
                min-width: 0 !important; 
                padding: 15px; 
            }

            /* ğŸ”¥ ë‹¬ë ¥ ì›€ì§ì´ê²Œ(ìŠ¤í¬ë¡¤) ë§Œë“œëŠ” í•µì‹¬ ì½”ë“œ */
            .calendar-section {
                overflow-x: auto; /* ì¢Œìš° ìŠ¤í¬ë¡¤ í—ˆìš© */
                -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            }

            #calendar {
                min-width: 600px; /* ë‹¬ë ¥ì´ ì°Œê·¸ëŸ¬ì§€ì§€ ì•Šë„ë¡ ìµœì†Œ ë„ˆë¹„ ê³ ì • */
                font-size: 12px;
            }

            /* ìº˜ë¦°ë” íˆ´ë°”(ì œëª©, ë²„íŠ¼)ê°€ ìŠ¤í¬ë¡¤í•´ë„ ë”°ë¼ì˜¤ê²Œ í•˜ë ¤ë©´ */
            .fc-header-toolbar {
                position: sticky;
                left: 0;
                width: 100%;
                margin-bottom: 10px !important;
            }

            /* ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ ë™ê·¸ë¼ë¯¸ í¬ê¸° ì¡°ì ˆ */
            .fc-day-today .fc-daygrid-day-number {
                min-width: 24px;
                height: 24px;
                margin: 2px 0 0 2px !important;
            }

            /* ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” ì„¹ì…˜ */
            .table-section { padding: 15px; margin: 20px auto; overflow-x: auto; }
            table { min-width: 600px; } 
        } 
    
            .time-select-container { flex-wrap: nowrap; }
            select { padding: 8px; font-size: 14px; }
        }
    </style>
</head>
<body>

<div class="title-container">
    <h1 ondblclick="checkAdmin()"> 
        ë‹¤ëª©ì  AIDT ìˆ˜í•™êµêµ¬ì‹¤ìŠµì‹¤(030408í˜¸) ì˜ˆì•½ ì‹œìŠ¤í…œ 
        <span id="adminBadge" class="admin-badge">ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ</span>
        <button id="adminExitBtn" class="admin-exit-btn" onclick="exitAdmin()">í•´ì œ</button>
    </h1>
</div>

<div class="main-container">
    <div class="form-section">
        <h3>ğŸ“… ì˜ˆì•½ ì‹ ì²­</h3>
        <p style="font-size: 0.82em; color: #8e8e93; margin-bottom: 20px; line-height: 1.5;">
            * ìš´ì˜ ì‹œê°„: <b>09:00 ~ 18:50</b><br>
            * ì˜¤ëŠ˜ë¶€í„° <b>6ì£¼ ì´ë‚´</b>ì˜ í‰ì¼ë§Œ ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
            * ì·¨ì†Œ ì‹œ ì˜ˆì•½ ì‹œ ì„¤ì •í•œ <b>ë¹„ë°€ë²ˆí˜¸</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
	* <b>ë¬¸ì˜ì‚¬í•­: 042-629-8548</b>
        </p>
        <form id="reservationForm">
            <div class="form-group">
                <label>í•™ë²ˆ</label>
                <input type="text" id="studentId" placeholder="20241234" minlength="8" maxlength="8" oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
            </div>
            <div class="form-group"><label>ì´ë¦„</label><input type="text" id="name" placeholder="ê¹€ìˆ˜êµ" required></div>
            <div class="form-group"><label>ì¸ì›ìˆ˜</label><input type="number" id="people" min="1" max="8" value="1" required></div>
            <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="date" required></div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 18px;">
                <div style="flex: 1;">
                    <label>ì‹œì‘ ì‹œê°„</label>
                    <div class="time-select-container">
                        <select id="startHour" required></select><span>ì‹œ</span>
                        <select id="startMin" required></select><span>ë¶„</span>
                    </div>
                </div>
                <div style="flex: 1;">
                    <label>ì¢…ë£Œ ì‹œê°„</label>
                    <div class="time-select-container">
                        <select id="endHour" required></select><span>ì‹œ</span>
                        <select id="endMin" required></select><span>ë¶„</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ì˜ˆì•½ì·¨ì†Œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ìˆ«ì 4ìë¦¬)</label>
                <input type="password" id="password" placeholder="****" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
            </div>
            
            <button type="submit" id="submitBtn">ì˜ˆì•½í•˜ê¸°</button>
        </form>
    </div>
    <div class="calendar-section"><div id='calendar'></div></div>
</div>

<div class="table-section">
    <div class="table-header">
        <div>
            <h3>ğŸ“‹ ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ (ì·¨ì†Œ ê°€ëŠ¥)</h3>
            <span id="listMonthIndicator" style="font-size: 0.85em; color:#8e8e93;">ë°ì´í„° ë¡œë”© ì¤‘...</span>
        </div>
        <button class="refresh-btn" id="refreshBtn" onclick="handleRefresh()">
            <svg viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path></svg>
            ìƒˆë¡œê³ ì¹¨
        </button>
    </div>
    <table id="reservationTable">
        <thead>
            <tr>
                <th>ìƒíƒœ</th><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>ì¸ì›</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ì·¨ì†Œ</th>
	    </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCUzc0RavySHdTy-KUXQ18mx-hPz5sN8gSIV8oQnRhvob1SmWN9Y_fo_MhIqi1hv28/exec"; 
    let reservations = [];
    let calendar;
    let isAdmin = false;
    let currentViewYear = new Date().getFullYear();
    let currentViewMonth = new Date().getMonth();

    // ì‹œê°„ ë“œë¡­ë‹¤ìš´ ìƒì„±
    function populateSplitTimeDropdowns() {
        const startHour = document.getElementById('startHour');
        const endHour = document.getElementById('endHour');
        const minIds = ['startMin', 'endMin'];
        const hours = Array.from({length: 10}, (_, i) => String(i + 9).padStart(2, '0')); 
        
        [startHour, endHour].forEach(select => {
            select.innerHTML = hours.map(h => `<option value="${h}">${h}</option>`).join('');
        });
        minIds.forEach(id => {
            const select = document.getElementById(id);
            select.innerHTML = ['00','10','20','30','40','50'].map(m => `<option value="${m}">${m}</option>`).join('');
        });
        startHour.value = "09";
        endHour.value = "10";
    }

    // ğŸ”“ê´€ë¦¬ì ëª¨ë“œ(ë³´ì•ˆ ê°•í™”)
    async function checkAdmin() {
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (pw === null) return;

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "adminCheck", password: pw })
            });

            const result = await response.json();

            if (result.isAdmin) {
                isAdmin = true;
                alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”");
                
                // UI ì—…ë°ì´íŠ¸: ë³´ë¼ìƒ‰ í…Œë§ˆ ì ìš©
                document.body.classList.add('admin-active'); 
                document.getElementById('adminBadge').style.display = 'inline-block'; // ğŸ”’ ë°°ì§€ í‘œì‹œ
                document.getElementById('adminExitBtn').style.display = 'inline-block'; // [í•´ì œ] ë²„íŠ¼ í‘œì‹œ
                
                updateTable(); // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í•´ì œë¥¼ ìœ„í•´ í…Œì´ë¸” ê°±ì‹ 
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        } catch (e) {
            console.error(e);
            alert("í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ í•´ì œ í•¨ìˆ˜ (ìˆ˜ì •ë³¸)
    function exitAdmin() {
        isAdmin = false;
        
        // UI ì—…ë°ì´íŠ¸: ì¼ë°˜ ëª¨ë“œë¡œ ë³µêµ¬
        document.body.classList.remove('admin-active');
        document.getElementById('adminBadge').style.display = 'none';
        document.getElementById('adminExitBtn').style.display = 'none'; // [í•´ì œ] ë²„íŠ¼ ìˆ¨ê¹€
        
        alert("ê´€ë¦¬ì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        updateTable(); // í•™ë²ˆ ë‹¤ì‹œ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬
    }

    // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    async function handleRefresh() {
        const btn = document.getElementById('refreshBtn');
        btn.classList.add('loading');
        btn.disabled = true;
        await loadReservations();
        setTimeout(() => {
            btn.classList.remove('loading');
            btn.disabled = false;
        }, 500);
    }

    // ë‹¬ë ¥ ì´ˆê¸°í™”
    function initCalendar() {
        const dateInput = document.getElementById('date');
        const now = new Date();
        const sixWeeksLater = new Date();
        sixWeeksLater.setDate(now.getDate() + 42);
        dateInput.min = now.toISOString().split('T')[0];
        dateInput.max = sixWeeksLater.toISOString().split('T')[0];

        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            locale: 'ko',
            height: 'auto', 
            contentHeight: 'auto',
            aspectRatio: 1.35, // ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ë¹„ìœ¨ ì¡°ì ˆ (ëª¨ë°”ì¼ì—ì„œ ì ë‹¹í•œ ë†’ì´ ìœ ì§€)
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
            slotMinTime: '09:00:00',
            slotMaxTime: '19:00:00',
            allDaySlot: false,
            datesSet: (info) => {
                currentViewYear = info.view.currentStart.getFullYear();
                currentViewMonth = info.view.currentStart.getMonth();
                document.getElementById('listMonthIndicator').innerText = `${currentViewYear}ë…„ ${currentViewMonth + 1}ì›” ì˜ˆì•½`;
                updateTable();
            },
            eventContent: (arg) => {
                let timeStr = arg.event.start.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                return { html: `<div class="event-item-custom"><span class="event-time-tag">${timeStr}</span><span class="event-title-tag">${arg.event.title}</span></div>` };
            }
        });
        calendar.render();
    }

    // ë°ì´í„° ë¡œë“œ
    async function loadReservations() {
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            reservations = data.filter(r => r.studentId && r.name && String(r.studentId) !== "undefined"); 
            updateCalendar();
            updateTable();
        } catch (e) { console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }
    }

    function updateCalendar() {
        const events = reservations.map(r => ({
            title: `${r.name}(${r.people}ëª…)`,
            start: `${r.date}T${r.startTime}`, end: `${r.date}T${r.endTime}`, allDay: false
        }));
        calendar.removeAllEvents();
        calendar.addEventSource(events);
    }

    // âœ… [ìˆ˜ì •ëœ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜]
    function updateTable() {
        const tbody = document.querySelector('#reservationTable tbody');
        tbody.innerHTML = '';
        const now = new Date();

        const filtered = reservations.filter(r => {
            const rDate = new Date(r.date + "T00:00:00");
            return rDate.getFullYear() === currentViewYear && rDate.getMonth() === currentViewMonth;
        }).map(r => {
            const startFull = new Date(`${r.date}T${r.startTime}`);
            const endFull = new Date(`${r.date}T${r.endTime}`);

            let status = "ì˜ˆì •";
            let statusClass = "tag-upcoming";
            let isPast = false;

            if (now > endFull) {
                status = "ì¢…ë£Œ";
                statusClass = "tag-past";
                isPast = true;
            } else if (now >= startFull && now <= endFull) {
                status = "ì§„í–‰ ì¤‘";
                statusClass = "tag-now";
                isPast = false;
            }

            return { ...r, status, statusClass, isPast, startFull };
        }).sort((a, b) => {
            // âœ… ì¢…ë£Œëœ ì˜ˆì•½ì€ ë’¤ë¡œ, ë‚˜ë¨¸ì§€ëŠ” ì‹œê°„ìˆœ ì •ë ¬
            if (a.isPast !== b.isPast) return a.isPast ? 1 : -1;
            return a.startFull - b.startFull;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="color:#8e8e93; padding: 40px;">ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        filtered.forEach((r) => {
            const displayId = isAdmin ? r.studentId : (r.studentId.toString().substring(0, 4) + "****");
            const idClass = isAdmin ? 'class="admin-id"' : '';
            const rowClass = r.isPast ? 'class="row-past"' : '';
    
            // âœ… ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì§€ë‚œ ì˜ˆì•½ì´ë©´ ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ê´€ë¦¬ì ì œì™¸)
            const hideCancel = (r.isPast || r.status === "ì§„í–‰ ì¤‘") && !isAdmin;
            
            // ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì—¬ ì‚­ì œ í•¨ìˆ˜ë¡œ ì „ë‹¬ (ìˆœì„œ ê¼¬ì„ ë°©ì§€ í•µì‹¬)
            const rDataString = JSON.stringify(r).replace(/"/g, '&quot;');
            const cancelBtnHtml = hideCancel ? '' : `<button class="cancel-btn" onclick="deleteReservation('${rDataString}')">ì·¨ì†Œ</button>`;

            tbody.innerHTML += `
                <tr ${rowClass}>
                    <td><span class="status-tag ${r.statusClass}">${r.status}</span></td>
                    <td ${idClass}>${displayId}</td>
                    <td>${r.name}</td>
                    <td>${r.people}ëª…</td>
                    <td>${r.date}</td>
                    <td>${r.startTime}~${r.endTime}</td>
                    <td>${cancelBtnHtml}</td>
                </tr>`;
        });
    }

    // âœ… [ìˆ˜ì •ëœ ì‚­ì œ ì²˜ë¦¬ í•¨ìˆ˜]
    async function deleteReservation(rDataJson) {
        const target = JSON.parse(rDataJson);
    
        let inputPw = "";
        if (!isAdmin) {
            inputPw = prompt("ì˜ˆì•½ ì‹œ ì„¤ì •í•œ 4ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (inputPw === null) return;
            if (inputPw.trim().length !== 4) { alert("ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ì…ë‹ˆë‹¤."); return; }
        }

        if (!confirm(`${target.date} ${target.startTime} ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const btn = event.target;
            const row = btn.closest('tr'); // í´ë¦­í•œ ë²„íŠ¼ì´ í¬í•¨ëœ í–‰(TR) ì°¾ê¸°
        
            // 1. í™”ë©´ì—ì„œ ì¦‰ì‹œ ìˆ¨ê¸°ê¸° (ì‚¬ìš©ìëŠ” ë°”ë¡œ ì‚­ì œëœ ê²ƒì²˜ëŸ¼ ëŠë‚Œ)
            row.style.transition = "all 0.4s ease";
            row.style.opacity = "0";
            row.style.transform = "translateX(20px)";
        
            // 2. ì„œë²„ì— ì‚­ì œ ìš”ì²­ ë³´ë‚´ê¸° (ë¹„ë™ê¸° ì²˜ë¦¬)
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ 
                    action: "delete", 
                    studentId: String(target.studentId).trim(),
                    date: String(target.date).trim(), 
                    startTime: String(target.startTime).trim(), 
                    password: String(inputPw).trim(), 
                    isAdmin: isAdmin 
                })
            }).then(() => {
                // ì„œë²„ ì‘ì—…ì´ ëë‚˜ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì¡°ìš©íˆ ë°ì´í„° ê°±ì‹ 
                loadReservations();
            });

            // 3. ì‚¬ìš©ìì—ê²ŒëŠ” ì¦‰ì‹œ ì•Œë¦¼ (ê¸°ë‹¤ë¦´ í•„ìš” ì—†ìŒ)
            // alert ëŒ€ì‹  ê°€ë²¼ìš´ ë©”ì‹œì§€ê°€ ì¢‹ì§€ë§Œ, ì¼ë‹¨ alertë¥¼ ì“´ë‹¤ë©´ ë°”ë¡œ ë„ì›ë‹ˆë‹¤.
            console.log("ì‚­ì œ ìš”ì²­ ì™„ë£Œ"); 

        } catch (e) { 
            console.error(e);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."); 
            loadReservations(); // ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ ë³µêµ¬
        }
    }

    // ì˜ˆì•½ ì‹ ì²­ ì´ë²¤íŠ¸
    document.getElementById('reservationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const studentIdInput = document.getElementById('studentId');
        const passwordInput = document.getElementById('password');
        const studentId = studentIdInput.value.trim();
        const password = passwordInput.value.trim();

        if (studentId.length !== 8) { alert("âš ï¸ í•™ë²ˆì€ ìˆ«ì 8ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤."); return; }
        if (password.length !== 4) { alert("âš ï¸ ì˜ˆì•½ ì·¨ì†Œ ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤."); return; }

        const startTime = document.getElementById('startHour').value + ":" + document.getElementById('startMin').value;
        const endTime = document.getElementById('endHour').value + ":" + document.getElementById('endMin').value;
        const dateVal = document.getElementById('date').value;

        if (endTime > "18:50") { alert("âš ï¸ ì¢…ë£Œ ì‹œê°„ì€ 18:50ë¶„ì„ ë„˜ê¸¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (startTime >= endTime) { alert("âš ï¸ ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

        const selectedDate = new Date(dateVal);
        const today = new Date();
        today.setHours(0,0,0,0);
        if (selectedDate.getDay() === 0 || selectedDate.getDay() === 6) { alert("âš ï¸ ì£¼ë§ì€ ìš´ì˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }

        const isOverlapping = reservations.some(r => {
            if (r.date !== dateVal) return false;
            return (startTime < r.endTime && endTime > r.startTime);
        });
        if (isOverlapping) { alert("âš ï¸ í•´ë‹¹ ì‹œê°„ì— ì´ë¯¸ ì˜ˆì•½ì´ ì¡´ì¬í•©ë‹ˆë‹¤."); return; }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerText = "ì²˜ë¦¬ ì¤‘...";

        try {
            const newRes = { 
                studentId, 
                name: document.getElementById('name').value, 
                people: document.getElementById('people').value, 
                date: dateVal, startTime, endTime, password 
            };
            
            await fetch(SCRIPT_URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'text/plain' }, 
                body: JSON.stringify(newRes) 
            });
            
            alert('ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            this.reset();
            populateSplitTimeDropdowns();
            loadReservations();
        } catch (e) { 
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); 
        } finally { 
            btn.disabled = false; btn.innerText = "ì˜ˆì•½í•˜ê¸°"; 
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        populateSplitTimeDropdowns();
        initCalendar();
        loadReservations();
    });
</script>
</body>
</html>
